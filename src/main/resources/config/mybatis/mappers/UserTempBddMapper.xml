<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.silita.biaodaa.dao.UserTempBddMapper">

    <select id="getUserByUserPhone" parameterType="String" resultType="com.silita.biaodaa.model.UserTempBdd">
        SELECT * FROM mishu_write.user_temp_bdd WHERE userPhone = #{userphone}
    </select>

    <insert id="InsertUserTemp" parameterType="com.silita.biaodaa.model.UserTempBdd">
        INSERT INTO mishu_write.user_temp_bdd(userId, userName, userPass, userPhone, nickName,
        gender, imgUrl, wx_unionId, qqopenId, loginChannel,
        registrationTime)
        VALUES(#{userid}, #{username}, #{userpass}, #{userphone}, #{nickname},
        #{gender}, #{imgurl}, #{wxUnionid}, #{qqopenid}, #{loginchannel},
        now())
    </insert>

    <select id="getUserByUserNameOrPhoneAndPassWd" parameterType="com.silita.biaodaa.model.UserTempBdd"
            resultType="com.silita.biaodaa.model.UserTempBdd">
        SELECT *
        FROM mishu_write.user_temp_bdd
        WHERE (userName = #{username} or userPhone = #{userphone}) AND userPass = #{userpass}
    </select>

    <update id="updateUserTempByWxBind" parameterType="com.silita.biaodaa.model.UserTempBdd">
        UPDATE mishu_write.user_temp_bdd
        <set>
            <if test="nickname!=null and nickname!=''">
                nickName = #{nickname},
            </if>
            <if test="imgurl!=null and imgurl!=''">
                imgUrl = #{imgurl},
            </if>
            <if test="gender!=null and gender!=''">
                gender = #{gender},
            </if>
            <if test="wxUnionid!=null and wxUnionid!=''">
                wx_unionId = #{wxUnionid},
            </if>
            <if test="userpass!=null and userpass!=''">
                userPass = #{userpass},
            </if>
            <if test="companyname!=null and companyname!=''">
                companyName = #{companyname},
            </if>
            <if test="birthday!=null and birthday!=''">
                birthday = #{birthday},
            </if>
            <if test="post!=null and post!=''">
                post = #{post},
            </if>
            <if test="city!=null and city!=''">
                city = #{city},
            </if>
            <if test="name!=null and name!=''">
                `name` = #{name}
            </if>
        </set>
        WHERE userPhone = #{userphone}
    </update>

    <update id="updateUserTempByQQBind" parameterType="com.silita.biaodaa.model.UserTempBdd">
        UPDATE mishu_write.user_temp_bdd
        SET
          nickName = #{nickname},
          imgUrl = #{imgurl},
          gender = #{gender},
          qqopenId = #{qqopenid} ,
          userPass = #{userpass},
          birthday = #{birthday},
          companyName = #{companyname},
          post = #{post},
          city = #{city},
          `name` = #{name}
        WHERE userPhone = #{userphone}
    </update>

    <select id="getUserTempByWXUnionId" parameterType="String" resultType="com.silita.biaodaa.model.UserTempBdd">
         SELECT * FROM mishu_write.user_temp_bdd WHERE wx_unionId = #{wxUnionid}
    </select>

    <select id="getUserTempByWXOpenId" parameterType="String" resultType="com.silita.biaodaa.model.UserTempBdd">
        SELECT * FROM mishu_write.user_temp_bdd WHERE wxopenId = #{wxopenid}
    </select>

    <update id="updateWXUnionIdByWXOpenId" parameterType="com.silita.biaodaa.model.UserTempBdd">
        UPDATE mishu_write.user_temp_bdd
        SET wx_unionId = #{wxUnionid}
        WHERE wxopenId = #{wxopenid}
    </update>

    <select id="getUserTempByQQOpenId" parameterType="String" resultType="com.silita.biaodaa.model.UserTempBdd">
        SELECT * FROM mishu_write.user_temp_bdd WHERE qqopenId = #{qqopenid}
    </select>

    <select id="getUserTempByUserId" parameterType="String" resultType="com.silita.biaodaa.model.UserTempBdd">
        SELECT * FROM mishu_write.user_temp_bdd WHERE userId = #{userid}
    </select>

    <update id="updateUserTemp" parameterType="com.silita.biaodaa.model.UserTempBdd">
        UPDATE mishu_write.user_temp_bdd
        <set>
            <if test="imgurl!=null and imgurl!=''">
                imgUrl = #{imgurl},
            </if>
            <if test="nickname!=null and nickname!=''">
                nickName = #{nickname},
            </if>
            <if test="gender!=null and gender!=''">
                gender = #{gender},
            </if>
            <if test="mailbox!=null and mailbox!=''">
                mailBox = #{mailbox},
            </if>
            <if test="companyname!=null and companyname!=''">
                companyName = #{companyname},
            </if>
            <if test="birthday!=null and birthday!=''">
                birthday = #{birthday},
            </if>
            <if test="post!=null and post!=''">
                post = #{post},
            </if>
            <if test="city!=null and city!=''">
                city = #{city},
            </if>
            <if test="name!=null and name!=''">
                `name` = #{name}
            </if>
        </set>
        WHERE userId = #{userid}
    </update>

    <update id="updatePassWdByUserIdAndPhone" parameterType="com.silita.biaodaa.model.UserTempBdd">
        UPDATE mishu_write.user_temp_bdd
        SET userPass = #{userpass}
        WHERE userPhone = #{userphone}
    </update>

    <select id="getTotalByUserPhone" parameterType="String" resultType="Integer">
        SELECT COUNT(*) FROM mishu_write.user_temp_bdd WHERE userPhone = #{userphone}
    </select>

    <select id="queryUserInfo" parameterType="com.silita.biaodaa.model.SysUser" resultType="com.silita.biaodaa.model.SysUser">
        SELECT u.*,r.code as role_code,r.name as role_name,r.permissions,v.vip_name,v.expired_date,v.level
        FROM mishu_write.sys_user_info u
        LEFT JOIN mishu_write.sys_user_role rel on rel.user_id= u.pkid
        LEFT JOIN mishu_write.sys_role_info r on r.pkid= rel.role_id
        LEFT JOIN mishu_write.tb_vip_info v on u.pkid=v.user_id
        WHERE
        <choose>
            <when test="pkid != null and pkid != ''">
                u.pkid=#{pkid}
            </when>
            <otherwise>
                (login_name = #{login_name} or phone_no = #{phone_no}) AND login_pwd = #{login_pwd}
            </otherwise>
        </choose>
    </select>

    <select id="verifyUserInfo"  resultType="String">
        SELECT u.pkid
        FROM mishu_write.sys_user_info u
        WHERE  phone_no=#{phone_no}
        <if test="login_name != null and login_name != ''">
            or login_name=#{login_name}
        </if>
    </select>

    <insert id="insertUserInfo" parameterType="com.silita.biaodaa.model.SysUser">
    insert into mishu_write.sys_user_info
        (pkid,
        <if test="login_name !=null and login_name!=''">
        login_name,
        </if>
        login_pwd,
        <if test="user_name !=null and user_name!=''">
        user_name,
        </if>
        <if test="sex !=null and sex!=''">
        sex,
        </if>
        phone_no,
        channel,
        <if test="nike_name !=null and nike_name!=''">
        nike_name,
        </if>
        <if test="cert_type !=null and cert_type!=''">
        cert_type,
        </if>
        <if test="cert_no !=null and cert_no!=''">
        cert_no,
        </if>
        <if test="email !=null and email!=''">
        email,
        </if>
        <if test="birth_year !=null and birth_year!=''">
        birth_year,
        </if>
        <if test="in_city !=null and in_city!=''">
        in_city,
        </if>
        <if test="in_company !=null and in_company!=''">
        in_company,
        </if>
        <if test="position !=null and position!=''">
        position,
        </if>
        <if test="image_url !=null and image_url!=''">
        image_url,
        </if>
        <if test="wx_union_id !=null and wx_union_id!=''">
        wx_union_id,
        </if>
        <if test="wx_open_id !=null and wx_open_id!=''">
        wx_open_id,
        </if>
        <if test="qq_open_id !=null and qq_open_id!=''">
        qq_open_id,
        </if>
        created,
        create_by,
        <if test="inviter_code !=null and inviter_code!=''">
        inviter_code,
        </if>
        own_invite_code)
    VALUES
        (#{pkid},
        <if test="login_name !=null and login_name!=''">
        #{login_name},
        </if>
        #{login_pwd},
        <if test="user_name !=null and user_name!=''">
        #{user_name},
        </if>
        <if test="sex !=null and sex!=''">
        #{sex},
        </if>
        #{phone_no},
        #{channel},
        <if test="nike_name !=null and nike_name!=''">
        #{nike_name},
        </if>
        <if test="cert_type !=null and cert_type!=''">
        #{cert_type},
        </if>
        <if test="cert_no !=null and cert_no!=''">
        #{cert_no},
        </if>
        <if test="email !=null and email!=''">
        #{email},
        </if>
        <if test="birth_year !=null and birth_year!=''">
        #{birth_year},
        </if>
        <if test="in_city !=null and in_city!=''">
        #{in_city},
        </if>
        <if test="in_company !=null and in_company!=''">
        #{in_company},
        </if>
        <if test="position !=null and position!=''">
        #{position},
        </if>
        <if test="image_url !=null and image_url!=''">
        #{image_url},
        </if>
        <if test="wx_union_id !=null and wx_union_id!=''">
        #{wx_union_id},
        </if>
        <if test="wx_open_id !=null and wx_open_id!=''">
        #{wx_open_id},
        </if>
        <if test="qq_open_id !=null and qq_open_id!=''">
        #{qq_open_id},
        </if>
        CURRENT_TIMESTAMP,
        #{create_by},
        <if test="inviter_code !=null and inviter_code!=''">
        #{inviter_code},
        </if>
        #{own_invite_code})
    </insert>
    
    <insert id="insertUserRole" parameterType="com.silita.biaodaa.model.SysUserRole">
    insert into mishu_write.sys_user_role
        (pkid,
        role_id,
        user_id,
        created,
        create_by)
    VALUES
        (#{pkid},
        (SELECT pkid from mishu_write.sys_role_info where code=#{role_code}),
        #{user_id},
        CURRENT_TIMESTAMP,
        #{create_by})
    </insert>
    
    <select id="verifyInviterCode" parameterType="com.silita.biaodaa.model.SysUser" resultType="Integer">
        SELECT count(1)
        FROM mishu_write.sys_user_info
        WHERE own_invite_code=#{inviter_code}
        <if test="pkid !=null and pkid!=''">
        and pkid !=#{pkid}
        </if>
    </select>

    <select id="existInviterCodeByUserId" parameterType="String" resultType="String">
        SELECT inviter_code
        FROM mishu_write.sys_user_info
        WHERE pkid =#{pkid}
    </select>

    <update id="updateSysUser">
        update mishu_write.sys_user_info
        SET
            <if test="login_name !=null and login_name!=''">
                login_name=#{login_name},
            </if>
            <if test="login_pwd !=null and login_pwd!=''">
              login_pwd=#{login_pwd},
            </if>
            <if test="user_name !=null and user_name!=''">
                user_name=#{user_name},
            </if>
            <if test="sex !=null">
                sex=#{sex},
            </if>
            <if test="nike_name !=null and nike_name!=''">
                nike_name=#{nike_name},
            </if>
            <if test="cert_type !=null and cert_type!=''">
                cert_type=#{cert_type},
            </if>
            <if test="cert_no !=null and cert_no!=''">
                cert_no=#{cert_no},
            </if>
            <if test="email !=null and email!=''">
                email=#{email},
            </if>
            <if test="birth_year !=null and birth_year!=''">
                birth_year=#{birth_year},
            </if>
            <if test="in_city !=null and in_city!=''">
                in_city=#{in_city},
            </if>
            <if test="in_company !=null and in_company!=''">
                in_company=#{in_company},
            </if>
            <if test="position !=null and position!=''">
                position=#{position},
            </if>
            <if test="image_url !=null and image_url!=''">
                image_url=#{image_url},
            </if>
            <if test="wx_union_id !=null and wx_union_id!=''">
                wx_union_id=#{wx_union_id},
            </if>
            <if test="wx_open_id !=null and wx_open_id!=''">
                wx_open_id=#{wx_open_id},
            </if>
            <if test="qq_open_id !=null and qq_open_id!=''">
                qq_open_id=#{qq_open_id},
            </if>
            <if test="update_by !=null and update_by!=''">
              update_by=#{update_by},
            </if>
            <if test="inviter_code !=null and inviter_code!=''">
                inviter_code=#{inviter_code},
            </if>
        updated=CURRENT_TIMESTAMP
        where pkid = #{pkid}

    </update>

</mapper>