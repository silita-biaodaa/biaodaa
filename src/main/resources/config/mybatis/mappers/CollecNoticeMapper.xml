<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.silita.biaodaa.dao.CollecNoticeMapper">


    <select id="getCollecNoticeByUserIdAndNoticeId" parameterType="com.silita.biaodaa.model.CollecNotice"
            resultType="com.silita.biaodaa.model.CollecNotice">
      SELECT * FROM mishu_write.collec_notice WHERE userId = #{userid} AND noticeId = #{noticeid}
    </select>

    <insert id="insertCollecNotice" parameterType="com.silita.biaodaa.model.CollecNotice">
      INSERT INTO mishu_write.collec_notice(userId, `type`, noticeId, noticeRelationNum, collecTime, readOrReaded,source)
      VALUES(#{userid}, #{type}, #{noticeid}, 0, NOW(), 0,#{source})
    </insert>

    <delete id="deleteCollecNoticeByUserIdAndNoticeId" parameterType="com.silita.biaodaa.model.CollecNotice">
        DELETE FROM mishu_write.collec_notice WHERE `userId` = #{userid} AND `noticeId` = #{noticeid}
    </delete>

    <select id="listZhaoBiaoCollecNoticeByUserId" parameterType="com.silita.biaodaa.model.CollecNotice"
            resultType="Map">
        SELECT n.userId, n.type, s.id, s.title, s.openDate,
        d.projDq, d.projXs, GROUP_CONCAT(d.pbMode) AS pbMode,<include
            refid="com.silita.biaodaa.dao.NoticeMapper.noticeTypeConvert"/>, temp.certificate
        FROM mishu_write.collec_notice n
        INNER JOIN mishu.snatchurl s ON s.id = n.noticeId
        LEFT JOIN mishu.zhaobiao_detail d ON s.id = d.snatchUrlId
        LEFT JOIN (SELECT GROUP_CONCAT(c.certificate) AS certificate, c.contId as contId
        FROM mishu.snatch_url_cert c
        LEFT JOIN mishu_write.collec_notice n1 ON n1.noticeId = c.contId
        WHERE n1.userId = #{userid} AND n1.type = #{type}
        GROUP BY n1.noticeId) temp ON temp.contId = d.snatchUrlId
        WHERE n.userId = #{userid} AND n.type = #{type}
        GROUP BY s.id
    </select>

    <select id="listZhongBiaoCollecNoticeByUserId" parameterType="com.silita.biaodaa.model.CollecNotice"
            resultType="Map">
        SELECT n.userId, n.type, s.id, s.title, s.openDate,
        (SELECT outdd.projSum from mishu.zhongbiao_detail outdd where outdd.id =(SELECT min(d.id) FROM
        mishu.zhongbiao_detail d WHERE d.snatchurlid =s.id )) AS projSum,
        (SELECT outdd.oneName from mishu.zhongbiao_detail outdd where outdd.id =(SELECT min(d.id) FROM
        mishu.zhongbiao_detail d WHERE d.snatchurlid =s.id )) AS oneName,
        (SELECT outdd.pbMode from mishu.zhongbiao_detail outdd where outdd.id =(SELECT min(d.id) FROM
        mishu.zhongbiao_detail d WHERE d.snatchurlid =s.id )) AS pbMode ,
        d.projType, d.projDq, d.projXs,
        <include refid="com.silita.biaodaa.dao.NoticeMapper.noticeTypeConvert"/>
        FROM mishu.snatchurl s
        INNER JOIN mishu_write.collec_notice n ON s.id = n.noticeId
        LEFT JOIN mishu.zhongbiao_detail d ON n.noticeId = d.snatchUrlId
        WHERE n.userId = #{userid} AND n.type = #{type}
        GROUP BY s.id
    </select>

    <select id="queryCollecList" parameterType="java.util.Map" resultType="com.silita.biaodaa.model.CollecNotice">
        SELECT * FROM mishu_write.collec_notice WHERE userId = #{userid} AND `type` = #{type}
    </select>

    <select id="listZhaoBiaoCollecNoticeById" parameterType="com.silita.biaodaa.model.CollecNotice"
            resultType="Map">
        SELECT #{userId} as userId,0 as `type`,s.id, s.title, s.openDate,#{source} as source,
        d.projDq, d.projXs, GROUP_CONCAT(d.pbMode) AS pbMode,<include
            refid="com.silita.biaodaa.dao.NoticeMapper.noticeTypeConvert"/>, temp.certificate
        FROM
        <choose>
            <when test="source != null and source != 'hunan'">
                mishu.snatchurl_${source} s
                LEFT JOIN mishu.zhaobiao_detail_others d ON s.id = d.snatchUrlId AND d.source = #{source}
            </when>
            <otherwise>
                mishu.snatchurl s
                LEFT JOIN mishu.zhaobiao_detail d ON s.id = d.snatchUrlId
            </otherwise>
        </choose>
        LEFT JOIN (SELECT GROUP_CONCAT(c.certificate) AS certificate, c.contId as contId
        FROM
        <choose>
            <when test="source != null and source != 'hunan'">
                mishu.snatch_url_cert_others c WHERE c.contId = #{noticeId} AND c.source = #{source} GROUP BY c.contId
            </when>
            <otherwise>
                mishu.snatch_url_cert c WHERE c.contId = #{noticeId} GROUP BY c.contId
            </otherwise>
        </choose>
       ) temp ON temp.contId = d.snatchUrlId
        WHERE s.id = #{noticeId}
        GROUP BY s.id
        limit 1
    </select>

    <select id="listZhongBiaoCollecNoticeById" parameterType="com.silita.biaodaa.model.CollecNotice"
            resultType="Map">
        SELECT #{userId} as userId, 2 as `type`, s.id, s.title, s.openDate,#{source} as source,
        <choose>
            <when test="source != null and source != 'hunan'">
                (SELECT outdd.projSum from mishu.zhongbiao_detail_others outdd where outdd.id =(SELECT min(d.id) FROM
                mishu.zhongbiao_detail_others d WHERE d.snatchurlid =s.id AND d.source = #{source})) AS projSum,
                (SELECT outdd.oneName from mishu.zhongbiao_detail_others outdd where outdd.id =(SELECT min(d.id) FROM
                mishu.zhongbiao_detail_others d WHERE d.snatchurlid =s.id AND d.source = #{source})) AS oneName,
                (SELECT outdd.pbMode from mishu.zhongbiao_detail_others outdd where outdd.id =(SELECT min(d.id) FROM
                mishu.zhongbiao_detail_others d WHERE d.snatchurlid =s.id AND d.source = #{source})) AS pbMode ,
            </when>
            <otherwise>
                (SELECT outdd.projSum from mishu.zhongbiao_detail outdd where outdd.id =(SELECT min(d.id) FROM
                mishu.zhongbiao_detail d WHERE d.snatchurlid =s.id )) AS projSum,
                (SELECT outdd.oneName from mishu.zhongbiao_detail outdd where outdd.id =(SELECT min(d.id) FROM
                mishu.zhongbiao_detail d WHERE d.snatchurlid =s.id )) AS oneName,
                (SELECT outdd.pbMode from mishu.zhongbiao_detail outdd where outdd.id =(SELECT min(d.id) FROM
                mishu.zhongbiao_detail d WHERE d.snatchurlid =s.id )) AS pbMode,
            </otherwise>
        </choose>
        d.projType, d.projDq, d.projXs,
        <include refid="com.silita.biaodaa.dao.NoticeMapper.noticeTypeConvert"/>
        FROM
        <choose>
            <when test="source != null and source != 'hunan'">
                mishu.snatchurl_${source} s
                LEFT JOIN mishu.zhongbiao_detail_others d ON s.id = d.snatchUrlId AND d.source = #{source}
            </when>
            <otherwise>
                mishu.snatchurl s
                LEFT JOIN mishu.zhongbiao_detail d ON s.id = d.snatchUrlId
            </otherwise>
        </choose>
        WHERE s.id = #{noticeId}
        GROUP BY s.id
        limit 1
    </select>
</mapper>